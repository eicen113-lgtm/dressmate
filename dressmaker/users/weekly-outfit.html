<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weekly Outfit | DressMate</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />

    <link rel="icon" type="image/png" href="../assets/logo.png" />

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(180deg, #ffeaf4 0%, #fff 100%);
        color: #333;
        min-height: 100vh;
      }

      .glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 182, 193, 0.5);
        border-radius: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .card {
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        position: relative;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 25px rgba(255, 182, 193, 0.4);
      }

      .item-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
        background-color: #f7f7f7;
        border: 1px solid #f9dae5;
        cursor: pointer; /* Make image clearly clickable */
      }

      .item-icon-box i {
        cursor: default;
      }

      /* Base button style */
      .action-btn {
        position: absolute;
        top: 10px;
        background: rgba(255, 255, 255, 0.8);
        color: #ec4899;
        font-size: 1rem;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        opacity: 0.8;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
      }

      /* Adjusted position since only delete is left */
      .delete-btn {
        right: 10px;
      }

      .card:hover .action-btn:hover {
        opacity: 1;
        transform: scale(1.1);
      }

      .card:hover .delete-btn:hover {
        color: white;
        background-color: #db2777;
      }

      /* Custom styles for the line chart container */
      #outfitChart {
        padding-top: 10px;
      }

      /* New style for the item flex container to save space */
      .item-flex-container {
        display: flex;
        gap: 0.5rem; /* Reduced gap */
        padding: 0.5rem; /* Reduced padding */
      }

      .item-icon-box {
        flex-shrink: 0;
        width: 40px; /* Smaller width */
        height: 40px; /* Smaller height */
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #fde8ef; /* Light pink background */
        color: #db2777; /* Darker pink icon */
      }

      /* Style for the new Pinned Table */
      #pinnedFavoritesTable {
        width: 100%;
        border-collapse: collapse;
      }
      #pinnedFavoritesTable th,
      #pinnedFavoritesTable td {
        padding: 10px 15px;
        text-align: left;
        border-bottom: 1px solid #fbcfe8; /* Light pink border */
      }
      #pinnedFavoritesTable th {
        background-color: #ffe4e6; /* Very light pink header */
        color: #831843; /* Darker pink text */
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.875rem;
      }
      #pinnedFavoritesTable tr:hover {
        background-color: #fff1f2;
      }
      .favorite-img-col {
        width: 60px;
      }
      .unfavorite-btn-table {
        background: #f43f5e;
        color: white;
        padding: 6px 12px;
        border-radius: 9999px;
        font-size: 0.75rem;
        transition: background-color 0.2s;
      }
      .unfavorite-btn-table:hover {
        background: #e11d48;
      }
    </style>
  </head>

  <body>
    <div class="flex-col min-h-screen">
      <header
        class="flex items-center justify-between px-6 py-4 bg-white/70 backdrop-blur-md shadow-sm fixed w-full z-50"
      >
        <div class="flex items-center gap-3">
          <a
            href="./dashboard.html"
            class="text-gray-700 hover:text-pink-600 flex items-center gap-2 transition font-medium"
          >
            <i class="fa-solid fa-arrow-left"></i> Back
          </a>
          <h1 class="text-xl font-semibold text-pink-600">
            Weekly Outfit Planner
          </h1>
        </div>
      </header>

      <main class="flex-1 flex flex-col px-6 pt-24 pb-12 max-w-7xl mx-auto">
        <section class="text-center mb-10" data-aos="fade-down">
          <h2 class="text-3xl font-bold text-gray-800 mb-2">
            Welcome,
            <span id="userNameDesktop" class="text-pink-600">Loading...</span>
            📅
          </h2>
          <p class="text-gray-600">Plan your style and visualize your usage!</p>
        </section>

        <section
          id="pinnedFavoritesSection"
          class="mb-10 hidden"
          data-aos="fade-up"
          data-aos-delay="50"
        >
          <div class="glass p-6">
            <h3
              class="text-xl font-bold text-pink-600 mb-4 flex items-center gap-2"
            >
              <i class="fa-solid fa-thumbtack"></i> Pinned Favorite Outfits
            </h3>
            <div class="overflow-x-auto">
              <table id="pinnedFavoritesTable"></table>
            </div>
          </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
          <div
            class="lg:col-span-1 glass p-6 card"
            data-aos="fade-up"
            data-aos-delay="100"
          >
            <h3
              class="text-xl font-bold text-pink-600 mb-4 flex items-center gap-2"
            >
              <i class="fa-solid fa-chart-line"></i> Weekly Plan Trend
            </h3>
            <div id="outfitChart"></div>
          </div>

          <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div
              class="glass p-6 card flex flex-col justify-center"
              data-aos="fade-up"
              data-aos-delay="200"
            >
              <p class="text-sm font-medium text-gray-500 mb-1">
                Total Planned Outfits
              </p>
              <p id="totalOutfits" class="text-4xl font-bold text-gray-800">
                0
              </p>
              <p class="text-sm text-pink-500 mt-2 flex items-center gap-1">
                <i class="fa-solid fa-calendar-check"></i> This week's style
                agenda.
              </p>
            </div>
            <div
              class="glass p-6 card flex flex-col justify-center"
              data-aos="fade-up"
              data-aos-delay="300"
            >
              <p class="text-sm font-medium text-gray-500 mb-1">
                Unique Items in Rotation
              </p>
              <p id="itemsInRotation" class="text-4xl font-bold text-gray-800">
                0
              </p>
              <p class="text-sm text-pink-500 mt-2 flex items-center gap-1">
                <i class="fa-solid fa-hand-sparkles"></i> Unique items planned.
              </p>
            </div>
          </div>
        </section>
        <button
          onclick="openOutfitForm()"
          class="mb-8 bg-pink-500 hover:bg-pink-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transition self-center"
        >
          <i class="fa-solid fa-plus-circle mr-2"></i> Add New Outfit Plan
        </button>

        <section
          id="outfitGrid"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full"
          data-aos="fade-up"
        >
          <p
            id="outfitGridStatus"
            class="col-span-full text-center text-gray-500"
          >
            Loading outfits...
          </p>
        </section>
      </main>

      <footer class="text-center text-gray-500 text-sm py-4 mt-auto">
        © 2025 DressMate. All rights reserved.
      </footer>
    </div>

    <div
      id="outfitModal"
      class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white rounded-2xl p-6 md:p-8 w-full max-w-2xl relative shadow-2xl overflow-y-auto max-h-[90vh]"
      >
        <button
          onclick="closeModal()"
          class="absolute top-5 right-5 text-gray-400 hover:text-gray-600"
        >
          <i class="fa-solid fa-xmark text-2xl"></i>
        </button>

        <h2
          class="text-2xl md:text-3xl font-bold text-pink-600 mb-6 text-center"
        >
          Add Outfit Plan
        </h2>

        <form id="outfitForm" class="space-y-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block font-semibold text-gray-700 mb-1">Date</label>
              <input
                id="date"
                type="date"
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-400"
                required
              />
            </div>

            <div>
              <label class="block font-semibold text-gray-700 mb-1"
                >Outfit Name</label
              >
              <input
                id="name"
                type="text"
                placeholder="e.g., Friday Casual"
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-400"
                required
              />
            </div>
          </div>

          <div class="space-y-4">
            <div class="border rounded-xl p-4 bg-pink-50 shadow-sm">
              <h3
                class="font-bold text-gray-800 mb-3 flex items-center gap-2 text-lg"
              >
                <i class="fa-solid fa-shirt text-pink-500"></i> Upper
                (Shirt/Jacket)
              </h3>
              <label class="block text-sm text-gray-600 mb-1"
                >Image (Optional)</label
              >
              <input
                id="upperImage"
                type="file"
                accept="image/*"
                class="mb-3 w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-100 file:text-pink-700 hover:file:bg-pink-200"
              />
              <label class="block text-sm text-gray-600 mb-1"
                >Description</label
              >
              <textarea
                id="upperDesc"
                placeholder="e.g., White polo shirt"
                rows="2"
                class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-pink-400"
              ></textarea>
            </div>

            <div class="border rounded-xl p-4 bg-pink-50 shadow-sm">
              <h3
                class="font-bold text-gray-800 mb-3 flex items-center gap-2 text-lg"
              >
                <i class="fa-solid fa-person text-pink-500"></i> Pants (Bottoms)
              </h3>
              <label class="block text-sm text-gray-600 mb-1"
                >Image (Optional)</label
              >
              <input
                id="pantsImage"
                type="file"
                accept="image/*"
                class="mb-3 w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-100 file:text-pink-700 hover:file:bg-pink-200"
              />
              <label class="block text-sm text-gray-600 mb-1"
                >Description</label
              >
              <textarea
                id="pantsDesc"
                placeholder="e.g., Dark blue jeans"
                rows="2"
                class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-pink-400"
              ></textarea>
            </div>

            <div class="border rounded-xl p-4 bg-pink-50 shadow-sm">
              <h3
                class="font-bold text-gray-800 mb-3 flex items-center gap-2 text-lg"
              >
                <i class="fa-solid fa-shoe-prints text-pink-500"></i> Shoes
              </h3>
              <label class="block text-sm text-gray-600 mb-1"
                >Image (Optional)</label
              >
              <input
                id="shoesImage"
                type="file"
                accept="image/*"
                class="mb-3 w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-100 file:text-pink-700 hover:file:bg-pink-200"
              />
              <label class="block text-sm text-gray-600 mb-1"
                >Description</label
              >
              <textarea
                id="shoesDesc"
                placeholder="e.g., White sneakers"
                rows="2"
                class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-pink-400"
              ></textarea>
            </div>
          </div>

          <div class="pt-2">
            <button
              type="button"
              id="saveOutfitButton"
              onclick="saveOutfit()"
              class="w-full bg-pink-500 hover:bg-pink-600 text-white font-semibold py-3 rounded-full shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2"
            >
              <i class="fa-solid fa-save"></i> Save Outfit Plan
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <script>
      AOS.init();
      let outfitLineChart = null;

      // *** ENHANCED viewLargeImage FUNCTION for better visual appeal ***
      window.viewLargeImage = function (imageUrl, altText) {
        if (!imageUrl) return;

        Swal.fire({
          // Minimal, clean title
          title: altText,
          html: `<img src="${imageUrl}" style="max-width: 100%; max-height: 80vh; object-fit: contain;" alt="${altText}">`,
          // Set imageUrl to null and use html to control the style and size better
          imageUrl: null,
          imageAlt: altText,
          width: "90%", // Larger width for desktop/mobile
          showConfirmButton: false,
          showCloseButton: true,
          padding: "1.5rem",
          // Modern, slightly transparent background
          background: "rgba(255, 255, 255, 0.98)",
          // Darker, blurrier backdrop
          backdrop: "rgba(0,0,0,0.8) blur(5px)",
          customClass: {
            // Remove default image class padding/style
            image: "hidden",
            // Ensure a smooth, rounded look
            popup: "rounded-2xl shadow-2xl",
            title: "text-2xl font-bold text-pink-700 mb-4",
          },
        });
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";

      const SUPABASE_URL = "https://iqirktmtuvqoeqrcqcqb.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxaXJrdG10dXZxb2VxcmNxY3FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NDkxNzMsImV4cCI6MjA3NTIyNTE3M30.nbxFIL3sqCnWSaKZl7X2y4KgpUw8UF_JC9_Ago1BQWo";

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const userNameEl = document.getElementById("userNameDesktop");
      const outfitGrid = document.getElementById("outfitGrid");
      const outfitGridStatus = document.getElementById("outfitGridStatus");
      const totalOutfitsEl = document.getElementById("totalOutfits");
      const itemsInRotationEl = document.getElementById("itemsInRotation");
      const saveOutfitButton = document.getElementById("saveOutfitButton");
      const pinnedFavoritesSection = document.getElementById(
        "pinnedFavoritesSection"
      );
      const pinnedFavoritesTable = document.getElementById(
        "pinnedFavoritesTable"
      );
      const BUCKET_NAME = "weekly-plan";

      function notify(icon, title) {
        Swal.fire({
          icon: icon,
          title: title,
          showConfirmButton: false,
          timer: 2000,
          toast: true,
          position: "top-end",
        });
      }

      window.openOutfitForm = () =>
        document.getElementById("outfitModal").classList.remove("hidden");

      window.closeModal = () => {
        document.getElementById("outfitModal").classList.add("hidden");
        document.getElementById("outfitForm").reset();
      };

      async function loadUser() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) {
          notify("warning", "Please log in to view your plans.");
          // window.location.href = "../index.html"; // Uncomment for production
          return null;
        }

        const { data: profile, error } = await supabase
          .from("users")
          .select("full_name, id")
          .eq("auth_id", user.id)
          .single();

        if (error || !profile) {
          userNameEl.textContent = "Guest";
          console.error("Profile load error:", error);
          return null;
        }

        userNameEl.textContent = profile.full_name || "User";
        return profile.id;
      }

      async function uploadImage(file, folder) {
        if (!file) return null;

        const fileName = `${folder}/${Date.now()}_${Math.random()
          .toString(36)
          .substring(2, 8)}.${file.name.split(".").pop()}`;

        const { error } = await supabase.storage
          .from(BUCKET_NAME)
          .upload(fileName, file);

        if (error) {
          notify(
            "error",
            `Image upload failed for ${folder}: ${error.message}`
          );
          console.error("Upload error:", error.message);
          return null;
        }

        const { data: publicUrl } = supabase.storage
          .from(BUCKET_NAME)
          .getPublicUrl(fileName);

        return publicUrl.publicUrl;
      }

      async function loadOutfits(userId) {
        if (outfitGrid.innerHTML === "") {
          outfitGridStatus.innerHTML =
            '<i class="fa-solid fa-sync fa-spin mr-2 text-pink-500"></i> Fetching real-time plans...';
        }

        const { data: outfits, error } = await supabase
          .from("weekly_outfits")
          .select("*, is_favorite")
          .eq("user_id", userId)
          // 1. Sort by is_favorite descending (TRUE comes first)
          // 2. Then, sort by outfit_date ascending (Oldest date first among favorites/non-favorites)
          .order("is_favorite", { ascending: false })
          .order("outfit_date", { ascending: true });

        if (error) {
          console.error("Error loading outfits:", error.message);
          outfitGridStatus.innerHTML =
            "<p class='text-red-500'>Error loading outfits.</p>";
          return;
        }

        updateStatsAndChart(outfits);
        renderPinnedFavorites(outfits.filter((o) => o.is_favorite));
        renderOutfitGrid(outfits);
      }

      function renderPinnedFavorites(favorites) {
        if (favorites.length === 0) {
          pinnedFavoritesSection.classList.add("hidden");
          pinnedFavoritesTable.innerHTML = "";
          return;
        }

        pinnedFavoritesSection.classList.remove("hidden");

        const tableHeader = `
            <thead>
                <tr>
                    <th class="favorite-img-col">Image</th>
                    <th>Date & Name</th>
                    <th>Upper</th>
                    <th>Pants</th>
                    <th>Shoes</th>
                    <th class="text-center">Action</th>
                </tr>
            </thead>
        `;

        const tableBody = favorites
          .map((outfit) => {
            const dateStr = new Date(outfit.outfit_date).toDateString();
            const mainImageUrl =
              outfit.upper_image || outfit.pants_image || outfit.shoes_image;

            return `
                <tr>
                    <td>
                        ${
                          mainImageUrl
                            ? `<img src="${mainImageUrl}" 
                                            class="w-10 h-10 object-cover rounded-md cursor-pointer" 
                                            alt="${outfit.outfit_name} Image"
                                            onclick="viewLargeImage('${mainImageUrl}', 'Pinned: ${outfit.outfit_name}')"
                                          >`
                            : '<i class="fa-solid fa-thumbtack text-pink-500 text-xl"></i>'
                        }
                    </td>
                    <td>
                        <p class="font-bold text-gray-800">${
                          outfit.outfit_name
                        }</p>
                        <p class="text-xs text-gray-500">${dateStr}</p>
                    </td>
                    <td class="text-sm text-gray-700">${
                      outfit.upper_desc || "-"
                    }</td>
                    <td class="text-sm text-gray-700">${
                      outfit.pants_desc || "-"
                    }</td>
                    <td class="text-sm text-gray-700">${
                      outfit.shoes_desc || "-"
                    }</td>
                    <td class="text-center">
                        <button class="unfavorite-btn-table" onclick="toggleFavorite('${
                          outfit.id
                        }', true)">
                            <i class="fa-solid fa-heart-crack mr-1"></i> Unfavorite
                        </button>
                    </td>
                </tr>
            `;
          })
          .join("");

        pinnedFavoritesTable.innerHTML =
          tableHeader + `<tbody>${tableBody}</tbody>`;
      }

      async function setupRealtimeSubscription(userId) {
        const channelName = `outfit_changes_${userId}`;
        // Ensure to remove existing channel to prevent duplicate listeners
        await supabase.removeChannel(supabase.channel(channelName));

        const channel = supabase.channel(channelName);

        channel
          .on(
            "postgres_changes",
            {
              event: "*",
              schema: "public",
              table: "weekly_outfits",
              filter: `user_id=eq.${userId}`,
            },
            (payload) => {
              console.log("Real-time update received:", payload.eventType);
              // Call loadOutfits to re-fetch and re-render with the new sorting applied
              loadOutfits(userId);

              // Only show notification for insert/delete (update is handled in toggleFavorite)
              if (payload.eventType === "INSERT") {
                notify("success", "🆕 New plan added!");
              }
            }
          )
          .subscribe();
        console.log("Supabase Realtime subscription active.");
      }

      function renderOutfitGrid(data) {
        outfitGrid.innerHTML = "";
        outfitGridStatus.innerHTML = "";

        // Filter out pinned items from the main grid view
        const unpinnedData = data.filter((o) => !o.is_favorite);

        if (!data || data.length === 0) {
          outfitGridStatus.innerHTML = `
            <p class='text-gray-500 mt-4 col-span-full'>
                <i class="fa-solid fa-box-open text-pink-500 mr-2"></i> No outfits planned yet. Click "Add New Outfit Plan" to start!
            </p>`;
          return;
        }

        // Render unpinned items in the main grid
        outfitGrid.innerHTML = unpinnedData
          .map(
            (outfit) => `
                <div class="card glass p-4 rounded-xl shadow-lg hover:shadow-xl transition relative flex flex-col justify-between" data-aos="fade-up">
                    
                    <button class="action-btn delete-btn" title="Delete Plan" onclick="deleteOutfit('${
                      outfit.id
                    }')">
                        <i class="fa-solid fa-trash-alt"></i>
                    </button>
                    <div>
                        <div class="flex items-center text-sm text-gray-500 mb-2">
                            <i class="fa-solid fa-calendar-alt mr-2 text-pink-500"></i> 
                            <span class="font-medium">${new Date(
                              outfit.outfit_date
                            ).toDateString()}</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3">${
                          outfit.outfit_name
                        }</h3>
                        
                        <div class="space-y-2"> ${renderItem(
                          "Upper",
                          outfit.upper_desc,
                          outfit.upper_image,
                          "shirt"
                        )}
                            ${renderItem(
                              "Pants",
                              outfit.pants_desc,
                              outfit.pants_image,
                              "person"
                            )}
                            ${renderItem(
                              "Shoes",
                              outfit.shoes_desc,
                              outfit.shoes_image,
                              "shoe-prints"
                            )}
                        </div>
                    </div>
                </div>
                `
          )
          .join("");
      }

      function renderItem(type, desc, image, icon) {
        if (!desc && !image) return "";

        return `
                <div class="item-flex-container bg-white rounded-lg border border-gray-100">
                    <div class="flex-shrink-0 w-12 h-12 rounded-lg overflow-hidden border border-pink-100">
                        ${
                          image
                            ? `<img src="${image}" 
                                        class="item-image w-full h-full object-cover" 
                                        alt="${type} - ${desc || "Image"}"
                                        onclick="viewLargeImage('${image}', '${type} - ${
                                desc || "Image"
                              }')"
                                >`
                            : `<div class="item-icon-box w-full h-full flex items-center justify-center">
                                <i class="fa-solid fa-${icon} text-lg"></i>
                            </div>`
                        }
                    </div>
                    <div class="flex-grow min-w-0">
                        <p class="text-xs font-semibold text-pink-600 truncate">${type}</p>
                        <p class="text-sm text-gray-700 truncate" title="${
                          desc || "No description"
                        }">${desc || `No description`}</p>
                    </div>
                </div>
            `;
      }

      function updateStatsAndChart(outfits) {
        // ... (Chart and stats calculation remains the same, omitted for brevity)
        totalOutfitsEl.textContent = outfits.length;

        let items = [];
        let dailyCounts = {
          Mon: 0,
          Tue: 0,
          Wed: 0,
          Thu: 0,
          Fri: 0,
          Sat: 0,
          Sun: 0,
        };
        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

        outfits.forEach((o) => {
          // Track items for rotation count
          if (o.upper_desc) items.push(o.upper_desc.toLowerCase().trim());
          if (o.pants_desc) items.push(o.pants_desc.toLowerCase().trim());
          if (o.shoes_desc) items.push(o.shoes_desc.toLowerCase().trim());

          // Track plans per day for the chart
          try {
            const date = new Date(o.outfit_date);
            // Get the day of the week (0=Sun, 1=Mon, ...)
            const dayIndex = date.getDay();
            const dayKey = dayNames[dayIndex];
            dailyCounts[dayKey]++;
          } catch (e) {
            console.warn("Invalid date in outfit data:", o.outfit_date);
          }
        });

        const uniqueItems = new Set(items.filter((item) => item !== "")); // Filter out empty strings
        itemsInRotationEl.textContent = uniqueItems.size;

        const seriesData = Object.values(dailyCounts);
        const categories = Object.keys(dailyCounts);

        const chartOptions = {
          series: [
            {
              name: "Outfits Planned",
              data: seriesData,
            },
          ],
          chart: {
            id: "outfitLineChartInstance", // Unique ID for updating
            type: "line",
            height: 280,
            toolbar: {
              show: false,
            },
            zoom: {
              enabled: false,
            },
          },
          colors: ["#EC4899"], // Pink color theme
          stroke: {
            curve: "smooth",
            width: 4,
          },
          markers: {
            size: 6,
            colors: ["#DB2777"],
            strokeColors: "#fff",
            strokeWidth: 2,
            hover: {
              size: 8,
            },
          },
          xaxis: {
            categories: categories,
            title: {
              text: "Day of the Week",
              style: {
                color: "#888",
                fontWeight: 600,
              },
            },
            labels: {
              style: {
                colors: "#555",
                fontSize: "12px",
              },
            },
          },
          yaxis: {
            title: {
              text: "Number of Plans",
              style: {
                color: "#888",
                fontWeight: 600,
              },
            },
            min: 0,
            tickAmount: Math.max(1, Math.max(...seriesData)), // Ensure ticks are sensible
            labels: {
              formatter: (val) => Math.round(val), // Show whole numbers
              style: {
                colors: "#555",
                fontSize: "12px",
              },
            },
          },
          grid: {
            borderColor: "#f1f1f1",
            strokeDashArray: 3,
          },
          tooltip: {
            y: {
              formatter: function (val) {
                return val + " Outfits";
              },
            },
          },
        };

        const chartEl = document.getElementById("outfitChart");
        // Check if chart is already rendered to avoid errors and update dynamically
        if (window.outfitLineChart) {
          window.outfitLineChart.updateOptions(chartOptions);
        } else {
          window.outfitLineChart = new ApexCharts(chartEl, chartOptions);
          window.outfitLineChart.render();
        }
      }

      window.saveOutfit = async function () {
        saveOutfitButton.disabled = true;
        saveOutfitButton.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

        const userId = await loadUser();
        if (!userId) {
          notify("error", "Authentication failed. Please log in.");
          saveOutfitButton.disabled = false;
          saveOutfitButton.innerHTML =
            '<i class="fa-solid fa-save"></i> Save Outfit Plan';
          return;
        }

        const outfitDate = document.getElementById("date").value;
        const outfitName = document.getElementById("name").value;

        if (!outfitDate || !outfitName) {
          notify("warning", "Please fill in the date and outfit name.");
          saveOutfitButton.disabled = false;
          saveOutfitButton.innerHTML =
            '<i class="fa-solid fa-save"></i> Save Outfit Plan';
          return;
        }

        // Collect images and descriptions
        const upperImageFile = document.getElementById("upperImage").files[0];
        const pantsImageFile = document.getElementById("pantsImage").files[0];
        const shoesImageFile = document.getElementById("shoesImage").files[0];
        const upperDesc = document.getElementById("upperDesc").value || null;
        const pantsDesc = document.getElementById("pantsDesc").value || null;
        const shoesDesc = document.getElementById("shoesDesc").value || null;

        // Upload images concurrently
        const [upperUrl, pantsUrl, shoesUrl] = await Promise.all([
          uploadImage(upperImageFile, "upper"),
          uploadImage(pantsImageFile, "pants"),
          uploadImage(shoesImageFile, "shoes"),
        ]);

        const { error } = await supabase.from("weekly_outfits").insert([
          {
            user_id: userId,
            outfit_date: outfitDate,
            outfit_name: outfitName,
            upper_image: upperUrl,
            upper_desc: upperDesc,
            pants_image: pantsUrl,
            pants_desc: pantsDesc,
            shoes_image: shoesUrl,
            shoes_desc: shoesDesc,
            is_favorite: false,
          },
        ]);

        if (error) {
          notify("error", "❌ Error saving outfit: " + error.message);
          console.error(error);
        } else {
          // No need to manually reload, Real-time subscription will trigger loadOutfits
          closeModal();
        }

        saveOutfitButton.disabled = false;
        saveOutfitButton.innerHTML =
          '<i class="fa-solid fa-save"></i> Save Outfit Plan';
      };

      window.toggleFavorite = async function (id, currentStatus) {
        const newStatus = !currentStatus;

        // 1. Perform the database update
        const { error } = await supabase
          .from("weekly_outfits")
          .update({
            is_favorite: newStatus,
          })
          .eq("id", id);

        // 2. Handle response
        if (error) {
          notify("error", "❌ Failed to update favorite status.");
          console.error(error);
        } else {
          // The real-time subscription will trigger a full reload (loadOutfits)
          notify(
            "info",
            newStatus
              ? "💖 Outfit pinned to the top!"
              : "💔 Outfit unfavorited."
          );
        }
      };

      window.deleteOutfit = async function (id) {
        const result = await Swal.fire({
          title: "Are you sure?",
          text: "This will delete the plan and all associated images!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#ec4899",
          cancelButtonColor: "#9ca3af",
          confirmButtonText:
            '<i class="fa-solid fa-trash-alt mr-1"></i> Yes, Delete It!',
        });

        if (!result.isConfirmed) return;

        // Fetch outfit details for image deletion
        const { data: outfit, error: fetchError } = await supabase
          .from("weekly_outfits")
          .select("upper_image, pants_image, shoes_image")
          .eq("id", id)
          .single();

        if (fetchError) {
          notify("error", "Failed to fetch outfit details for deletion.");
          console.error(fetchError);
          return;
        }

        // Delete the record from the database
        const { error: deleteError } = await supabase
          .from("weekly_outfits")
          .delete()
          .eq("id", id);

        if (deleteError) {
          notify("error", "❌ Failed to delete outfit: " + deleteError.message);
          console.error(deleteError);
          return;
        }

        notify("success", "✅ Outfit plan deleted successfully!");

        // Handle storage cleanup
        const images = [
          outfit.upper_image,
          outfit.pants_image,
          outfit.shoes_image,
        ].filter((url) => url);
        if (images.length > 0) {
          const filePaths = images
            .map((url) => {
              try {
                // Ensure correct path extraction from Supabase public URL
                const urlPath = new URL(url).pathname;
                const pathParts = urlPath.split(`/${BUCKET_NAME}/`);
                // Check if the URL contains the expected bucket path structure
                if (pathParts.length > 1) {
                  // pathParts[1] is the part after `/weekly-plan/`
                  const fullPathAfterPublic = pathParts[1];
                  const pathIndex = fullPathAfterPublic.indexOf("/public/");
                  return fullPathAfterPublic.substring(pathIndex + 7);
                }
                return null;
              } catch (e) {
                console.error(
                  "Failed to parse image URL for deletion:",
                  url,
                  e
                );
                return null;
              }
            })
            .filter((path) => path);

          if (filePaths.length > 0) {
            const { error: storageError } = await supabase.storage
              .from(BUCKET_NAME)
              .remove(filePaths);
            if (storageError) {
              console.warn(
                "Could not delete some files from storage:",
                storageError
              );
            }
          }
        }
      };

      document.addEventListener("DOMContentLoaded", async () => {
        const userId = await loadUser();
        if (userId) {
          loadOutfits(userId);
          setupRealtimeSubscription(userId);
        } else {
          outfitGridStatus.innerHTML =
            '<p class="text-gray-500 text-center col-span-full">Please log in to manage your weekly plans.</p>';
          totalOutfitsEl.textContent = "N/A";
          itemsInRotationEl.textContent = "N/A";
        }
      });
    </script>
  </body>
</html>
