<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | DressMate</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />

    <link rel="icon" type="image/png" href="../assets/logo.png" />

    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(180deg, #ffeaf4 0%, #fff 100%);
        color: #333;
        min-height: 100vh;
      }

      .glass {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 182, 193, 0.3);
      }

      .card {
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(255, 182, 193, 0.3);
      }

      .icon-btn:hover {
        transform: scale(1.05);
      }

      /* Added style for the clickable preference card */
      .preference-card-clickable {
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .preference-card-clickable:hover {
        box-shadow: 0 10px 20px rgba(255, 182, 193, 0.3);
        transform: scale(1.02);
      }

      /* Modal specific styles for animation */
      .modal {
        transition: opacity 0.3s ease-in-out;
      }

      .modal-content {
        transition: transform 0.3s ease-in-out;
        transform: translateY(-20px);
      }

      .modal.active {
        opacity: 1;
        pointer-events: auto;
      }

      .modal.active .modal-content {
        transform: translateY(0);
      }
    </style>
  </head>

  <body>
    <div
      class="md:hidden flex flex-col items-center justify-center min-h-screen px-4 bg-gray-50"
    >
      <div
        class="bg-white shadow-lg rounded-3xl p-5 w-full max-w-sm border border-pink-100"
        data-aos="fade-up"
      >
        <div class="flex items-center justify-between mb-5">
          <div class="flex items-center gap-2">
            <img
              src="../assets/logo.png"
              alt="DressMate Logo"
              class="w-9 h-9 rounded-full"
            />
            <h1 class="text-lg font-semibold text-pink-600">DressMate</h1>
          </div>
          <button
            id="logoutBtnMobile"
            class="text-pink-500 hover:text-pink-700 text-base transition flex items-center gap-1 font-medium"
          >
            <i class="fa-solid fa-right-from-bracket"></i>
          </button>
        </div>

        <div class="text-center mb-5">
          <h2 class="text-xl font-semibold text-gray-800">Welcome back,</h2>
          <p
            id="userNameMobile"
            class="text-pink-600 font-semibold text-base mt-1"
          >
            Loading...
          </p>
        </div>

        <div class="flex flex-col gap-3">
          <a href="./upload-clothes.html" class="block">
            <div
              class="card bg-pink-50 border border-pink-100 rounded-2xl p-3 flex items-center justify-between hover:shadow-md transition"
              data-aos="fade-up"
              data-aos-delay="100"
            >
              <div class="flex items-center gap-2">
                <i class="fa-solid fa-shirt text-pink-500 text-2xl"></i>
                <div>
                  <h3 class="font-semibold text-gray-800 text-sm">
                    Upload Clothes
                  </h3>
                  <p class="text-gray-500 text-xs">Add your favorite outfits</p>
                </div>
              </div>
              <i class="fa-solid fa-plus text-pink-400 text-lg"></i>
            </div>
          </a>

          <a href="./weekly-outfit.html" class="block">
            <div
              class="card bg-orange-50 border border-orange-100 rounded-2xl p-3 flex items-center justify-between hover:bg-orange-100 transition duration-200 cursor-pointer"
              data-aos="fade-up"
              data-aos-delay="150"
            >
              <div class="flex items-center gap-2">
                <i
                  class="fa-solid fa-calendar-week text-orange-500 text-2xl"
                ></i>
                <div>
                  <h3 class="font-semibold text-gray-800 text-sm">
                    Weekly Outfit Planner
                  </h3>
                  <p class="text-gray-500 text-xs">Plan your looks ahead</p>
                </div>
              </div>
              <i class="fa-solid fa-pen text-orange-400 text-lg"></i>
            </div>
          </a>

          <a href="./closet-insight.html" class="block">
            <div
              class="card bg-orange-50 border border-orange-100 rounded-2xl p-3 flex items-center justify-between hover:bg-orange-100 transition duration-200 cursor-pointer"
              data-aos="fade-up"
              data-aos-delay="200"
            >
              <div class="flex items-center gap-2">
                <i class="fa-solid fa-chart-pie text-blue-500 text-2xl"></i>
                <div>
                  <h3 class="font-semibold text-gray-800 text-sm">
                    Closet Insights
                  </h3>
                  <p class="text-gray-500 text-xs mt-1">
                    Get style stats and wardrobe analytics.
                  </p>
                </div>
              </div>
              <i class="fa-solid fa-pen text-blue-400 text-lg"></i>
            </div>
          </a>
        </div>

        <button
          onclick="window.location.href='start.html'"
          class="w-full bg-pink-500 hover:bg-pink-600 text-white font-semibold py-2 rounded-full transition shadow-md hover:shadow-lg mt-5"
          data-aos="zoom-in"
          data-aos-delay="300"
        >
          Get Started
        </button>

        <div id="userPreferencesMobile" class="mt-5"></div>
      </div>
    </div>

    <div class="hidden md:flex flex-col min-h-screen">
      <header
        class="flex items-center justify-between px-6 py-4 bg-white/70 backdrop-blur-md shadow-sm fixed w-full z-50"
      >
        <div class="flex items-center gap-3">
          <img
            src="../assets/logo.png"
            alt="DressMate Logo"
            class="w-10 h-10"
          />
          <h1 class="text-xl font-semibold text-pink-600">
            DressMate Dashboard
          </h1>
        </div>

        <button
          id="logoutBtnDesktop"
          class="text-gray-700 hover:text-pink-600 flex items-center gap-2 transition font-medium icon-btn"
        >
          <i class="fa-solid fa-right-from-bracket text-lg"></i> Logout
        </button>
      </header>

      <main
        class="flex-1 flex flex-col items-center justify-center px-6 pt-24 pb-12"
      >
        <section class="text-center mb-10" data-aos="fade-down">
          <h2 class="text-3xl font-bold text-gray-800 mb-2">
            Welcome back,
            <span id="userNameDesktop" class="text-pink-600">Loading...</span>
            ðŸ‘—
          </h2>
          <p class="text-gray-600">Your digital wardrobe assistant awaits.</p>
        </section>

        <section
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 max-w-5xl w-full"
          data-aos="fade-up"
        >
          <div
            class="glass rounded-2xl shadow-md p-6 flex flex-col items-center text-center hover:shadow-lg transition duration-300"
          >
            <i class="fa-solid fa-shirt text-pink-500 text-5xl mb-4"></i>
            <h3 class="font-semibold text-lg text-gray-800">Upload Clothes</h3>
            <p class="text-gray-600 text-sm mt-1 mb-4">
              Add and organize your outfits with ease.
            </p>
            <a
              href="./upload-clothes.html"
              class="bg-pink-500 hover:bg-pink-600 text-white font-semibold px-6 py-2 rounded-full transition"
              >Upload</a
            >
          </div>

          <div
            class="glass rounded-2xl shadow-md p-6 flex flex-col items-center text-center hover:shadow-lg transition duration-300"
          >
            <i
              class="fa-solid fa-calendar-week text-orange-500 text-5xl mb-4"
            ></i>
            <h3 class="font-semibold text-lg text-gray-800">
              Weekly Outfit Planner
            </h3>
            <p class="text-gray-600 text-sm mt-1 mb-4">
              Plan your looks for the week ahead.
            </p>
            <a
              href="./weekly-outfit.html"
              class="bg-orange-500 hover:bg-orange-600 text-white font-semibold px-6 py-2 rounded-full transition inline-block"
            >
              Plan Now
            </a>
          </div>

          <div
            class="glass rounded-2xl shadow-md p-6 flex flex-col items-center text-center hover:shadow-lg transition duration-300"
          >
            <i class="fa-solid fa-chart-pie text-blue-500 text-5xl mb-4"></i>
            <h3 class="font-semibold text-lg text-gray-800">Closet Insights</h3>
            <p class="text-gray-600 text-sm mt-1 mb-4">
              Get style stats and wardrobe analytics.
            </p>
            <a
              href="./closet-insight.html"
              class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-6 py-2 rounded-full transition"
              >View Stats
            </a>
          </div>
        </section>

        <div class="mt-12" data-aos="zoom-in">
          <button
            onclick="window.location.href='start.html'"
            class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-3 px-10 rounded-full shadow-md transition"
          >
            Get Started <i class="fa-solid fa-arrow-right ml-2"></i>
          </button>
        </div>

        <div
          id="userPreferencesDesktop"
          class="mt-6 hidden md:block max-w-md w-full"
        ></div>
      </main>

      <footer class="text-center text-gray-500 text-sm py-4 mt-auto">
        Â© 2025 DressMate. All rights reserved.
      </footer>
    </div>

    <div
      id="preferenceDetailModal"
      class="modal fixed inset-0 bg-black/50 flex items-center justify-center z-[9998] opacity-0 pointer-events-none transition-opacity"
    >
      <div
        class="modal-content bg-white rounded-2xl shadow-2xl p-6 w-[95%] max-w-md mx-4 transform"
      >
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-pink-600 flex items-center">
            <i class="fa-solid fa-star mr-2"></i> Full Style Preference
          </h2>
          <button
            onclick="hideDetailModal()"
            class="text-gray-500 hover:text-gray-800 text-2xl"
          >
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div
          id="modalPreferencesBody"
          class="grid grid-cols-2 gap-3 mb-6 text-sm"
        ></div>

        <p
          id="prefTimestamp"
          class="text-gray-500 text-xs text-center mb-4"
        ></p>

        <div class="flex justify-between gap-3">
          <button
            onclick="hideDetailModal()"
            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium px-4 py-2 rounded-lg transition"
          >
            Close
          </button>
          <button
            id="deletePrefBtn"
            onclick="deletePreference()"
            class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium px-4 py-2 rounded-lg transition flex items-center justify-center"
          >
            <i class="fa-solid fa-trash-can mr-2"></i> Delete Preference
          </button>
        </div>
      </div>
    </div>

    <div
      id="logoutModal"
      class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] backdrop-blur-sm"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl p-8 text-center w-[90%] max-w-sm"
      >
        <i
          class="fa-solid fa-right-from-bracket text-pink-500 text-4xl mb-4"
        ></i>
        <h2 class="text-xl font-semibold text-gray-800 mb-2">Logging out...</h2>
        <p class="text-gray-600 mb-6">
          You will be logged out in
          <span id="logoutTimer" class="font-bold text-pink-600">5</span>
          seconds.
        </p>
        <div class="flex justify-center gap-3">
          <button
            id="cancelLogoutBtn"
            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium px-4 py-2 rounded-lg transition"
          >
            Cancel
          </button>
        </div>
        <div
          id="loadingBarContainer"
          class="w-full bg-gray-200 h-2 rounded-full mt-5 overflow-hidden"
        >
          <div
            id="loadingBar"
            class="bg-pink-500 h-full w-0 transition-all duration-1000"
          ></div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <script>
      AOS.init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      const supabase = window.supabase.createClient(
        "https://iqirktmtuvqoeqrcqcqb.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxaXJrdG10dXZxb2VxcmNxY3FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NDkxNzMsImV4cCI6MjA3NTIyNTE3M30.nbxFIL3sqCnWSaKZl7X2y4KgpUw8UF_JC9_Ago1BQWo"
      );

      let latestPreference = null; // Global variable to store the latest preference object
      let currentUserId = null;

      // --- Preference Modal Logic ---

      function showDetailModal() {
        if (!latestPreference) return;

        const modal = document.getElementById("preferenceDetailModal");
        const body = document.getElementById("modalPreferencesBody");
        const timestampEl = document.getElementById("prefTimestamp");

        // Define all preferences with their icons and friendly names
        const prefItems = [
          { key: "gender", label: "Gender", icon: "fa-venus-mars" },
          { key: "outfit_type", label: "Style", icon: "fa-tie" },
          { key: "upper", label: "Upper", icon: "fa-tshirt" },
          { key: "pants", label: "Pants", icon: "fa-person-walking" },
          { key: "shoes", label: "Shoes", icon: "fa-shoe-prints" },
        ];

        // Build the HTML for the modal body
        body.innerHTML = prefItems
          .map(
            (item) => `
                <div class="p-3 bg-gray-100 rounded-lg shadow-sm">
                    <p class="text-xs font-medium text-gray-500">${
                      item.label
                    }</p>
                    <p class="text-base font-semibold text-gray-800 flex items-center mt-1">
                        <i class="fa-solid ${
                          item.icon
                        } text-pink-500 mr-2"></i> 
                        ${latestPreference[item.key] || "Not Set"}
                    </p>
                </div>
            `
          )
          .join("");

        // Update timestamp
        const date = new Date(latestPreference.created_at).toLocaleDateString();
        timestampEl.textContent = `Saved on: ${date}`;

        // Show modal
        modal.classList.add("active");
        modal.classList.remove("opacity-0", "pointer-events-none");
      }

      function hideDetailModal() {
        const modal = document.getElementById("preferenceDetailModal");
        modal.classList.remove("active");
        modal.classList.add("opacity-0", "pointer-events-none");
      }

      async function deletePreference() {
        if (!latestPreference || !latestPreference.id) {
          alert("No preference selected to delete.");
          return;
        }

        if (
          !confirm(
            "Are you sure you want to delete your latest style preference? This action cannot be undone."
          )
        ) {
          return;
        }

        const btn = document.getElementById("deletePrefBtn");
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Deleting...`;

        // Delete from Supabase
        const { error } = await supabase
          .from("user_preferences_simple")
          .delete()
          .eq("id", latestPreference.id); // Assuming 'id' is the primary key of the row

        if (error) {
          alert("Error deleting preference: " + error.message);
          btn.disabled = false;
          btn.innerHTML = `<i class="fa-solid fa-trash-can mr-2"></i> Delete Preference`;
          return;
        }

        // Success: Hide modal, clear global data, and reload the dashboard view
        hideDetailModal();
        latestPreference = null;
        loadUserPreferences(currentUserId); // Reload data
        alert("Preference deleted successfully!");
      }

      // --- Core Logic ---

      document.addEventListener("DOMContentLoaded", async () => {
        const { data, error } = await supabase.auth.getUser();
        if (error || !data.user) {
          window.location.href = "../login.html";
          return;
        }

        const authId = data.user.id;

        // Fetch profile with users.id
        const { data: profile, error: fetchError } = await supabase
          .from("users")
          .select("id, full_name")
          .eq("auth_id", authId)
          .single();

        const name = fetchError ? "User" : profile.full_name;
        document.getElementById("userNameMobile").textContent = name;
        document.getElementById("userNameDesktop").textContent = name;

        // Set currentUserId and load preferences
        currentUserId = !fetchError ? profile.id : authId;
        loadUserPreferences(currentUserId);
      });

      // Logout Modal Logic (remains the same)
      const logoutModal = document.getElementById("logoutModal");
      const cancelLogoutBtn = document.getElementById("cancelLogoutBtn");
      const logoutTimerEl = document.getElementById("logoutTimer");
      const loadingBar = document.getElementById("loadingBar");

      let countdown;
      let timeLeft = 5;

      async function startLogoutCountdown() {
        logoutModal.classList.remove("hidden");
        timeLeft = 5;
        logoutTimerEl.textContent = timeLeft;
        loadingBar.style.width = "0%";

        countdown = setInterval(async () => {
          timeLeft--;
          logoutTimerEl.textContent = timeLeft;
          loadingBar.style.width = `${(5 - timeLeft) * 20}%`;

          if (timeLeft <= 0) {
            clearInterval(countdown);
            await supabase.auth.signOut();
            window.location.href = "../login.html";
          }
        }, 1000);
      }

      function cancelLogout() {
        clearInterval(countdown);
        logoutModal.classList.add("hidden");
        loadingBar.style.width = "0%";
      }

      document
        .getElementById("logoutBtnMobile")
        .addEventListener("click", startLogoutCountdown);
      document
        .getElementById("logoutBtnDesktop")
        .addEventListener("click", startLogoutCountdown);
      cancelLogoutBtn.addEventListener("click", cancelLogout);

      async function loadUserPreferences(userId) {
        const { data: preferences, error } = await supabase
          .from("user_preferences_simple")
          .select("*") // Select all to get the ID for deletion
          .eq("user_id", userId)
          .order("created_at", { ascending: false })
          .limit(1); // Get latest preference

        if (error || !preferences || preferences.length === 0) {
          latestPreference = null; // Clear global preference
          const noPrefHTML = `
            <div class="glass p-6 rounded-2xl shadow-lg text-center text-gray-500 transition transform hover:scale-105">
                <i class="fa-solid fa-circle-exclamation text-2xl text-pink-500 mb-2"></i>
                <p class="font-medium">No preferences set yet. Click 'Get Started' to set one!</p>
            </div>
        `;
          document.getElementById("userPreferencesMobile").innerHTML =
            noPrefHTML;
          document.getElementById("userPreferencesDesktop").innerHTML =
            noPrefHTML;
          return;
        }

        const pref = preferences[0];
        latestPreference = pref; // Store for the detail modal and deletion

        const prefHTML = `
        <div class="glass p-6 rounded-2xl shadow-lg preference-card-clickable" onclick="showDetailModal()">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center flex items-center justify-center">
                <i class="fa-solid fa-shirt text-pink-500 mr-2"></i>
                Your Latest Style Preference 
                <i class="fa-solid fa-chevron-right text-base text-pink-400 ml-2"></i>
            </h3>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div class="flex flex-col items-center justify-center p-3 bg-pink-50 rounded-xl shadow-sm">
                    <i class="fa-solid fa-tshirt text-pink-500 text-2xl mb-1"></i>
                    <p class="font-medium text-gray-700 text-sm">Upper</p>
                    <p class="text-gray-600 text-xs">${pref.upper || "-"}</p>
                </div>
                <div class="flex flex-col items-center justify-center p-3 bg-orange-50 rounded-xl shadow-sm">
                    <i class="fa-solid fa-person-walking text-orange-500 text-2xl mb-1"></i>
                    <p class="font-medium text-gray-700 text-sm">Pants</p>
                    <p class="text-gray-600 text-xs">${pref.pants || "-"}</p>
                </div>
                <div class="flex flex-col items-center justify-center p-3 bg-blue-50 rounded-xl shadow-sm">
                    <i class="fa-solid fa-shoe-prints text-blue-500 text-2xl mb-1"></i>
                    <p class="font-medium text-gray-700 text-sm">Shoes</p>
                    <p class="text-gray-600 text-xs">${pref.shoes || "-"}</p>
                </div>
            </div>
            <p class="text-gray-500 text-xs mt-4 text-center">
                Click to view all details.
            </p>
        </div>
    `;

        document.getElementById("userPreferencesMobile").innerHTML = prefHTML;
        document.getElementById("userPreferencesDesktop").innerHTML = prefHTML;
      }
    </script>
  </body>
</html>
