<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Login | DressMate</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="../assets/logo.png" />

    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, #fceaff 0%, #fff0f5 100%);
        min-height: 100vh;
        overflow: hidden;
        transition: opacity 0.5s ease;
      }

      .fade-out {
        opacity: 0;
      }

      .glass {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 192, 203, 0.6);
        box-shadow: 0 10px 30px rgba(236, 72, 153, 0.1);
      }

      .swal2-popup {
        font-family: "Poppins", sans-serif !important;
        border-radius: 1rem !important;
      }
      .swal2-title {
        color: #db2777 !important;
      }
    </style>
  </head>

  <body class="flex items-center justify-center px-4">
    <div
      class="w-full max-w-sm glass rounded-2xl shadow-2xl p-8 text-gray-800"
      data-aos="fade-down"
      data-aos-duration="1000"
    >
      <div class="text-center mb-8">
        <img
          src="../../assets/logo.png"
          alt="DressMate Logo"
          class="mx-auto w-20 h-20 mb-3"
          data-aos="zoom-in"
          data-aos-delay="200"
        />
        <h1
          class="text-3xl font-bold text-pink-700 mt-2"
          data-aos="fade-up"
          data-aos-delay="400"
        >
          Admin Portal
        </h1>
        <p class="text-gray-600 mt-1" data-aos="fade-up" data-aos-delay="500">
          Secure login for administrators
        </p>
      </div>

      <form
        id="loginForm"
        class="space-y-6"
        data-aos="fade-up"
        data-aos-delay="600"
      >
        <div>
          <label
            for="email"
            class="block text-sm font-semibold text-gray-700 mb-1"
          >
            <i class="fas fa-envelope mr-2 text-pink-500"></i> Email
          </label>
          <input
            type="email"
            id="email"
            name="email"
            placeholder="admin@dressmate.com"
            required
            class="w-full px-4 py-3 rounded-xl border border-pink-300 focus:ring-4 focus:ring-pink-200 transition duration-200 text-gray-800 placeholder-gray-400"
          />
        </div>

        <div>
          <label
            for="password"
            class="block text-sm font-semibold text-gray-700 mb-1"
          >
            <i class="fas fa-lock mr-2 text-pink-500"></i> Password
          </label>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="••••••••"
            required
            class="w-full px-4 py-3 rounded-xl border border-pink-300 focus:ring-4 focus:ring-pink-200 transition duration-200 text-gray-800 placeholder-gray-400"
          />
        </div>

        <button
          type="submit"
          class="w-full bg-pink-600 hover:bg-pink-700 text-white py-3 rounded-full font-bold uppercase tracking-wider transition duration-300 shadow-lg hover:shadow-xl transform hover:scale-[1.01]"
        >
          <i class="fas fa-sign-in-alt mr-2"></i> Admin Log In
        </button>
      </form>

      <p class="text-xs text-center text-gray-500 mt-6">
        <i class="fas fa-user-shield mr-1"></i> Access restricted to system
        administrators.
      </p>
    </div>

    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <script>
      AOS.init();

      function notify(icon, title, text) {
        Swal.fire({
          icon: icon,
          title: title,
          text: text,
          toast: true,
          position: "top-end",
          showConfirmButton: false,
          timer: 4000, // Increased time to read complex errors
          timerProgressBar: true,
          customClass: {
            popup: "swal2-popup",
            title: "swal2-title",
          },
        });
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      // Initialize Supabase
      const SUPABASE_URL = "https://iqirktmtuvqoeqrcqcqb.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxaXJrdG10dXZxb2VxcmNxY3FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NDkxNzMsImV4cCI6MjA3NTIyNTE3M30.nbxFIL3sqCnWSaKZl7X2y4KgpUw8UF_JC9_Ago1BQWo";
      const supabaseClient = supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      const loginForm = document.getElementById("loginForm");

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        const loginButton = e.target.querySelector('button[type="submit"]');

        if (!email || !password) {
          notify(
            "warning",
            "Missing Fields",
            "Please enter both email and password."
          );
          return;
        }

        // --- Step 1: Attempt Authentication via Supabase Auth ---
        loginButton.disabled = true;
        loginButton.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-2"></i> Authenticating...';
        loginButton.classList.add("opacity-70", "cursor-not-allowed");

        const { data: authData, error: authError } =
          await supabaseClient.auth.signInWithPassword({
            email,
            password,
          });

        if (authError) {
          notify("error", "Login Failed", authError.message);
          loginButton.disabled = false;
          loginButton.innerHTML =
            '<i class="fas fa-sign-in-alt mr-2"></i> Admin Log In';
          loginButton.classList.remove("opacity-70", "cursor-not-allowed");
          return;
        }

        const userId = authData.user.id; // <-- CAPTURE THE AUTHENTICATED USER'S UUID

        // --- Step 2: Check for Admin Role using the Custom SECURE Table (UUID Check) ---

        console.log(`User ID authenticated: ${userId}. Checking admin role...`); // Debug output

        const { data: adminData, error: adminCheckError } = await supabaseClient
          .from("admin_users_secure") // <-- ASSUMES SECURE TABLE NAME
          .select("id, is_active")
          .eq("auth_id", userId) // <-- CHECKING BY UUID (SECURE METHOD)
          .eq("is_active", true)
          .single();

        // Check for a genuine database/RLS error (PGRST116 means "no row found" - which is fine)
        if (adminCheckError && adminCheckError.code !== "PGRST116") {
          console.error("Database Check Error:", adminCheckError);

          // Log out the user to prevent partial login
          await supabaseClient.auth.signOut();

          // Show the specific error message to help debug RLS issues
          notify(
            "error",
            "Admin Check Error",
            `DB permission issue. Message: ${adminCheckError.message}`
          );

          loginButton.disabled = false;
          loginButton.innerHTML =
            '<i class="fas fa-sign-in-alt mr-2"></i> Admin Log In';
          loginButton.classList.remove("opacity-70", "cursor-not-allowed");
          return;
        }

        // If no data was found (including the expected PGRST116 "no rows found" error), deny access.
        if (!adminData) {
          // Log out the user immediately
          await supabaseClient.auth.signOut();

          notify(
            "error",
            "Access Denied",
            "Your authenticated account is not registered as an administrator."
          );

          loginButton.disabled = false;
          loginButton.innerHTML =
            '<i class="fas fa-sign-in-alt mr-2"></i> Admin Log In';
          loginButton.classList.remove("opacity-70", "cursor-not-allowed");
          return;
        }

        // --- Step 3: Success and Redirect ---
        notify(
          "success",
          "Login Successful!",
          "Redirecting to admin dashboard..."
        );

        document.body.classList.add("fade-out");
        setTimeout(() => {
          window.location.href = "./dashboard.html";
        }, 500);
      });
    </script>
  </body>
</html>

